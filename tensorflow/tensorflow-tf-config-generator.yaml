apiVersion: v1
kind: ConfigMap
metadata:
  name: tensorflow-tf-config-generator
  namespace: kubeflow-system
data:
  generate_tf_config.sh: |
    #!/bin/bash
    # TensorFlow ë¶„ì‚° í•™ìŠµìš© TF_CONFIG ìë™ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
    # Kubeflow Training Operator v2ì—ì„œ ì œê³µí•˜ëŠ” í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©

    set -e

    echo "=========================================="
    echo "ğŸ”§ TF_CONFIG ìƒì„± ì‹œì‘"
    echo "=========================================="

    # 1. Hostnameì—ì„œ ì •ë³´ ì¶”ì¶œ
    HOSTNAME=$(hostname)
    echo "Hostname: $HOSTNAME"

    # job_name ì¶”ì¶œ: hostnameì—ì„œ -node-0-X ì œê±°
    # ì˜ˆ: "tensorflow-job-node-0-2" â†’ "tensorflow-job"
    JOB_NAME=$(echo $HOSTNAME | sed 's/-node-0-.*//')

    # worker_index ì¶”ì¶œ: hostnameì˜ ë§ˆì§€ë§‰ ìˆ«ì
    WORKER_INDEX=$(echo $HOSTNAME | grep -o '[0-9]*$')

    # 2. í™˜ê²½ë³€ìˆ˜ì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    NUM_WORKERS=${PET_NNODES:-1}
    NAMESPACE=${NAMESPACE:-default}
    PORT=${TF_PORT:-2222}

    echo "Job Name: $JOB_NAME"
    echo "Worker Index: $WORKER_INDEX"
    echo "Total Workers: $NUM_WORKERS"
    echo "Namespace: $NAMESPACE"
    echo "Port: $PORT"

    # 3. Worker ëª©ë¡ ìƒì„±
    WORKERS="["
    for i in $(seq 0 $((NUM_WORKERS-1))); do
        if [ $i -gt 0 ]; then
            WORKERS="$WORKERS,"
        fi
        WORKER_ADDR="${JOB_NAME}-node-0-${i}.${JOB_NAME}.${NAMESPACE}.svc.cluster.local:${PORT}"
        WORKERS="$WORKERS\"${WORKER_ADDR}\""
    done
    WORKERS="$WORKERS]"

    # 4. TF_CONFIG JSON ìƒì„±
    export TF_CONFIG="{\"cluster\":{\"worker\":$WORKERS},\"task\":{\"type\":\"worker\",\"index\":$WORKER_INDEX}}"

    # 5. í™•ì¸ ì¶œë ¥
    echo ""
    echo "âœ… TF_CONFIG ìƒì„± ì™„ë£Œ!"
    echo "TF_CONFIG=$TF_CONFIG"
    echo "=========================================="
