apiVersion: trainer.kubeflow.org/v1alpha1
kind: ClusterTrainingRuntime
metadata:
  name: pytorch-simple
  labels:
    trainer.kubeflow.org/framework: pytorch
spec:
  mlPolicy:
    numNodes: 1  # ê¸°ë³¸ ë‹¨ì¼ ë…¸ë“œ
    torch:
      numProcPerNode: "auto"  # GPU ìˆìœ¼ë©´ GPU ìˆ˜, ì—†ìœ¼ë©´ CPU ìˆ˜ ìë™ ê°ì§€
  template:
    spec:
      replicatedJobs:
        - name: node
          template:
            metadata:
              labels:
                trainer.kubeflow.org/trainjob-ancestor-step: trainer
            spec:
              template:
                spec:
                  containers:
                    - name: node
                      image: pytorch/pytorch:2.2.2-cuda11.8-cudnn8-runtime
                      command:
                        - bash
                        - -c
                        - |
                          echo "==========================================="
                          echo "ğŸ”§ PyTorch ë¶„ì‚° í•™ìŠµ í™˜ê²½ ì„¤ì •"
                          echo "==========================================="

                          # PET í™˜ê²½ë³€ìˆ˜ë¥¼ PyTorch í‘œì¤€ í™˜ê²½ë³€ìˆ˜ë¡œ ë³€í™˜
                          export RANK=${PET_NODE_RANK:-0}
                          export WORLD_SIZE=${PET_NNODES:-1}
                          export MASTER_ADDR=${PET_MASTER_ADDR:-localhost}
                          export MASTER_PORT=${PET_MASTER_PORT:-29500}
                          export LOCAL_RANK=0
                          export NCCL_DEBUG=INFO

                          echo "âœ… PyTorch í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ!"
                          echo "  - RANK: $RANK"
                          echo "  - WORLD_SIZE: $WORLD_SIZE"
                          echo "  - MASTER_ADDR: $MASTER_ADDR"
                          echo "  - MASTER_PORT: $MASTER_PORT"
                          echo "  - LOCAL_RANK: $LOCAL_RANK"
                          echo "==========================================="
                          echo ""

                          # ì‚¬ìš©ì í•™ìŠµ ì½”ë“œ ì‹¤í–‰
                          # TrainJobì˜ podTemplateOverridesì—ì„œ /workspace/scriptsë¥¼ ë§ˆìš´íŠ¸í•˜ë©´ í•´ë‹¹ ê²½ë¡œ ì‚¬ìš©
                          if [ -f /workspace/scripts/train.py ]; then
                            python /workspace/scripts/train.py
                          else
                            python train.py
                          fi
                      env:
                        - name: PYTHONUNBUFFERED
                          value: "1"
