apiVersion: trainer.kubeflow.org/v1alpha1
kind: TrainJob
metadata:
  name: pytorch-distributed-simple
  namespace: kubeflow-system
spec:
  runtimeRef:
    name: pytorch-runtime
  trainer:
    image: pytorch/pytorch:2.2.2-cuda11.8-cudnn8-runtime
    numNodes: 2  # Runtime의 기본값(1) 오버라이드
    # numProcPerNode 생략 → Runtime의 "auto" 사용
    command:
      - bash
      - -c
      - |
        # PyTorch 환경변수 설정
        export RANK=${PET_NODE_RANK:-0}
        export LOCAL_RANK=${PET_LOCAL_RANK:-0}
        export WORLD_SIZE=${PET_NNODES:-1}
        export MASTER_ADDR=${PET_MASTER_ADDR:-localhost}
        export MASTER_PORT=${PET_MASTER_PORT:-29500}

        # Git repo에서 학습 코드 실행
        cd /git/code
        python3 pytorch/train.py
    resourcesPerNode:
      limits:
        cpu: "4"
        memory: "16Gi"
        nvidia.com/gpu: "1"
      requests:
        cpu: "2"
        memory: "8Gi"
        nvidia.com/gpu: "1"
  # 학습 스크립트 볼륨 마운트만 설정
  podTemplateOverrides:
    - targetJobs:
        - name: node
      spec:
        volumes:
          - name: train-script  # 사용자 학습 코드
            configMap:
              name: pytorch-distributed-train-script
              defaultMode: 0755
        # NOTE: Container 오버라이드 시 image 필드가 사라지는 문제로 인해
        #       volumeMount는 Runtime에 직접 추가하거나 다른 방법 사용 필요


